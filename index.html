<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Chess Stats Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="site.css?1" />
    </head>
    <body>
        <div id="app">
            <h1>Chess Stats Viewer</h1>
            <button
                v-for="period in periods"
                @click="fetchStats(period)"
                :key="period"
            >
                {{ period.charAt(0).toUpperCase() + period.slice(1) }}
            </button>
            <div>Last updated: <span>{{ lastFetch }}</span></div>
            <div class="stats" v-for="result in results" :key="result.username">
                <h2>
                    <a
                        :href="`https://www.chess.com/member/${result.username}`"
                        target="_blank"
                        >{{ result.username }}</a
                    >
                </h2>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Played</th>
                            <th>Won</th>
                            <th>Lost</th>
                            <th>Draw</th>
                            <th>Duration</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr
                            v-for="(details, type) in result.statsByType"
                            :key="type"
                            @click="openModal(details.games)"
                        >
                            <td>
                                <img
                                    :src="`icons/${type.toLowerCase()}.svg`"
                                    :alt="type"
                                />
                            </td>
                            <td>{{ details.played }}</td>
                            <td>
                                {{ details.won }}
                                <i class="percentage"
                                    >{{ percentage(details.won, details.played)
                                    }}%</i
                                >
                            </td>
                            <td>
                                {{ details.lost }}
                                <i class="percentage"
                                    >{{ percentage(details.lost, details.played)
                                    }}%</i
                                >
                            </td>
                            <td>
                                {{ details.draw }}
                                <i class="percentage"
                                    >{{ percentage(details.draw, details.played)
                                    }}%</i
                                >
                            </td>
                            <td>{{ formatDuration(details.duration) }}</td>
                            <td>{{ details.rating }}</td>
                        </tr>
                        <tr v-if="totalStats[result.username].played > 0">
                            <td><strong>Total</strong></td>
                            <td>
                                <strong
                                    >{{ totalStats[result.username].played
                                    }}</strong
                                >
                            </td>
                            <td>
                                <strong
                                    >{{ totalStats[result.username].won
                                    }}</strong
                                >
                                <i class="percentage"
                                    >({{
                                    percentage(totalStats[result.username].won,
                                    totalStats[result.username].played) }}%)</i
                                >
                            </td>
                            <td>
                                <strong
                                    >{{ totalStats[result.username].lost
                                    }}</strong
                                >
                                <i class="percentage"
                                    >({{
                                    percentage(totalStats[result.username].lost,
                                    totalStats[result.username].played) }}%)</i
                                >
                            </td>
                            <td>
                                <strong
                                    >{{ totalStats[result.username].draw
                                    }}</strong
                                >
                                <i class="percentage"
                                    >({{
                                    percentage(totalStats[result.username].draw,
                                    totalStats[result.username].played) }}%)</i
                                >
                            </td>
                            <td>
                                <strong>
                                    {{
                                    formatDuration(totalStats[result.username].duration)
                                    }}
                                </strong>
                            </td>
                            <td></td>
                            <!-- Rating is not totalled; you may calculate an average or similar if appropriate -->
                        </tr>
                    </tbody>
                </table>
            </div>
            <div v-if="showModal" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeModal">&times;</span>
                    <h2>Games</h2>
                    <table>
                        <tr v-for="game in currentGames" :key="game.id">
                            <td>
                                <span
                                    class="chess-icon"
                                    :class="{'icon-result-draw': game.result === 'draw', 'icon-result-win': game.result === 'won', 'icon-result-lost': game.result === 'lost'}"
                                ></span>
                            </td>
                            <td>
                                <a :href="game.url" target="_blank">
                                    {{ game.white.username }}
                                    <span v-if="game.accuracies"
                                        >({{ game.accuracies.white }}%)</span
                                    >
                                </a>
                            </td>
                            <td>
                                <a :href="game.url" target="_blank">
                                    {{ game.black.username }}
                                    <span v-if="game.accuracies">
                                        ({{ game.accuracies.black }}%)</span
                                    >
                                </a>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <script src="chessStats.js"></script>
    </body>
</html>
